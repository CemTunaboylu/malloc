#!/bin/sh
set -e 

# Determine upstream tracking branch
upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$upstream" ]; then
  # List changed C source files between upstream and current HEAD
  changed_c_files=$(git diff --name-only "$upstream"...HEAD -- '*.c')

  if [ -z "$changed_c_files" ]; then
    printf "No .c files changed since %s; skipping tests.\n" "$upstream"
    exit 0
  else
    printf "Detected .c file changes since %s; running tests...\n" "$upstream"
  fi
else
  echo "No upstream tracking branch configured; running tests for safety..."
fi

# Only run interpose tests on macOS, since they're Darwin-only
if [ "$(uname -s)" = "Darwin" ]; then
  echo "==> Running interposed tests (make clean test-interpose)..."
  make clean test-interpose
fi

echo "==> Running Linux container tests (make clean test-container)..."
make clean test-container

# Print success message in green
printf "\033[0;32mAll pre-push checks passed.\033[0m\n"